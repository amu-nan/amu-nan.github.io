<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Search - Xforia</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/detailed-search.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/chatbot/latest/chatbot.css">
    <script src="https://cdn.dhtmlx.com/chatbot/latest/chatbot.js"></script>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="../images/logo.png" alt="Xforia COAST Logo" class="logo">
            <span class="tagline">Your tagline goes here.</span>
        </div>
        <div class="coast-flow-header">
            <div class="coast-step-container">
                <span class="coast-letter">C</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">O</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">A</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter active">S</span>
                <span class="coast-step-name active">Search</span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">T</span>
                <span class="coast-step-name"></span>
            </div>
        </div>
    </header>

    <main class="detailed-search-page">
        <section class="detailed-search-content">
            <h2 id="org-name-header" class="org-name-display"></h2>
            
            <div class="entity-selection-info">
                <p>Welcome, <span id="selected-entity-display"></span>. Please make your selections to proceed.</p>
                <div id="entity-dropdowns" class="dropdown-container">
                    </div>
            </div>

            <div class="continue-options">
                <p>Choose your action:</p>
                <div class="option-buttons">
                    <button class="nav-option active" data-option="upload">Upload</button>
                    <button class="nav-option" data-option="chatbot">Chatbot</button>
                </div>
            </div>

            <div id="dynamic-content">
                </div>

            <div class="navigation-buttons">
                <button class="back-button" onclick="window.location.href='search.html'">Back</button>
                <button id="continue-to-report-btn" class="continue-button">Continue to Generate Report</button>
            </div>
        </section>
    </main>

    <script src="../js/scripts.js"></script>
    <script>
        const orgNameHeader = document.getElementById('org-name-header');
        const selectedEntityDisplay = document.getElementById('selected-entity-display');
        const entityDropdowns = document.getElementById('entity-dropdowns');
        const navOptions = document.querySelectorAll('.nav-option');
        const dynamicContent = document.getElementById('dynamic-content');
        const continueToReportBtn = document.getElementById('continue-to-report-btn');

        const orgName = sessionStorage.getItem('orgName');
        const selectedEntity = sessionStorage.getItem('selectedFinalEntity');
        
        // Hardcoded data to simulate the excel upload
        const excelData = [
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '200', Nurse_name: 'Samuel Kim', Patient_name: 'Emily Johnson', Patient_ID: '300' },
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '200', Nurse_name: 'Samuel Kim', Patient_name: 'Liam Chen', Patient_ID: '301' },
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '201', Nurse_name: 'Olivia Garcia', Patient_name: 'Noah Smith', Patient_ID: '302' },
        ];
        
        const workingData = excelData; // Use hardcoded data for now

        if (orgName) orgNameHeader.textContent = orgName;
        if (selectedEntity) selectedEntityDisplay.textContent = selectedEntity;

        let selectedPatient = null;
        let selectedNurse = null;
        let selectedOwner = null;

        function updatePatientDropdown(nurseName = null) {
            const patientInput = document.getElementById('patient-select-input');
            if (!patientInput) return;

            let patients = [];
            if (nurseName) {
                patients = workingData
                    .filter(row => row.Nurse_name === nurseName)
                    .map(row => row.Patient_name);
            } else {
                patients = workingData.map(row => row.Patient_name);
            }
            
            const uniquePatients = [...new Set(patients)];
            sessionStorage.setItem('availablePatients', JSON.stringify(uniquePatients));
            
            // Clear current input and reset value
            patientInput.value = '';
            selectedPatient = null;
        }

        function createSearchableDropdown(label, data, id, isPrimary = false) {
            const container = document.createElement('div');
            container.classList.add('dropdown-group');

            const labelEl = document.createElement('label');
            labelEl.textContent = label;
            container.appendChild(labelEl);

            const inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.placeholder = `Search for ${label.toLowerCase()}`;
            inputEl.id = `${id}-input`;
            inputEl.autocomplete = 'off';
            container.appendChild(inputEl);

            const resultsEl = document.createElement('ul');
            resultsEl.classList.add('autocomplete-results');
            container.appendChild(resultsEl);

            let allData = [...new Set(data)];
            if (label === 'Patient Names' && selectedNurse) {
                allData = workingData
                    .filter(row => row.Nurse_name === selectedNurse)
                    .map(row => row.Patient_name);
            }

            inputEl.addEventListener('focus', () => {
                resultsEl.innerHTML = '';
                allData.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.addEventListener('click', () => {
                        inputEl.value = item;
                        resultsEl.innerHTML = '';
                        if (isPrimary) {
                            if (label === 'Nurse Names') {
                                selectedNurse = item;
                                sessionStorage.setItem('selectedNurse', item);
                                updatePatientDropdown(selectedNurse);
                            } else if (label === 'Owner Names') {
                                selectedOwner = item;
                                sessionStorage.setItem('selectedOwner', item);
                            }
                            if (label === 'Patient Names') {
                                selectedPatient = item;
                                sessionStorage.setItem('selectedPatient', item);
                            }
                        }
                    });
                    resultsEl.appendChild(li);
                });
            });

            inputEl.addEventListener('input', () => {
                const query = inputEl.value.toLowerCase();
                resultsEl.innerHTML = '';
                const filteredData = allData.filter(item => item.toLowerCase().includes(query));
                filteredData.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.addEventListener('click', () => {
                        inputEl.value = item;
                        resultsEl.innerHTML = '';
                        if (isPrimary) {
                            if (label === 'Nurse Names') {
                                selectedNurse = item;
                                sessionStorage.setItem('selectedNurse', item);
                                updatePatientDropdown(selectedNurse);
                            } else if (label === 'Owner Names') {
                                selectedOwner = item;
                                sessionStorage.setItem('selectedOwner', item);
                            }
                            if (label === 'Patient Names') {
                                selectedPatient = item;
                                sessionStorage.setItem('selectedPatient', item);
                            }
                        }
                    });
                    resultsEl.appendChild(li);
                });
            });

            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    resultsEl.innerHTML = '';
                }
            });

            entityDropdowns.appendChild(container);
        }

        function renderDropdowns() {
            entityDropdowns.innerHTML = '';
            if (selectedEntity === 'patient' || selectedEntity === 'relative') {
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select', true);
            } else if (selectedEntity === 'nurse') {
                const nurseNames = [...new Set(workingData.map(row => row.Nurse_name))];
                createSearchableDropdown('Nurse Names', nurseNames, 'nurse-select', true);
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select', true);
            } else if (selectedEntity === 'owner') {
                const ownerNames = [...new Set(workingData.map(row => row.Owner_name))];
                createSearchableDropdown('Owner Names', ownerNames, 'owner-select', true);
                const nurseNames = [...new Set(workingData.map(row => row.Nurse_name))];
                createSearchableDropdown('Nurse Names', nurseNames, 'nurse-select', true);
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select', true);
            }
        }
        
        renderDropdowns();

        navOptions.forEach(button => {
            button.addEventListener('click', (e) => {
                navOptions.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                const option = e.target.dataset.option;
                dynamicContent.innerHTML = '';

                if (option === 'upload') {
                    dynamicContent.innerHTML = `
                        <div class="upload-section">
                            <h3>Upload More Documents</h3>
                            <p>Select a file and click upload. The patient information will be linked automatically based on your selection.</p>
                            <form id="metadata-upload-form">
                                <div class="metadata-group">
                                    <label for="file-upload-2">Choose a file to upload:</label>
                                    <input type="file" id="file-upload-2" required>
                                </div>
                                <button type="submit" class="option-button">Upload Document</button>
                            </form>
                        </div>
                    `;
                    document.getElementById('metadata-upload-form').addEventListener('submit', (event) => {
                        event.preventDefault();
                        const file = document.getElementById('file-upload-2').files[0];
                        
                        const patientName = document.getElementById('patient-select-input')?.value;
                        const selectedPatientData = workingData.find(p => p.Patient_name === patientName);

                        if (!selectedPatientData) {
                            alert("Please select a patient from the dropdown.");
                            return;
                        }

                        const payload = {
                            metadata: {
                                patient_name: selectedPatientData.Patient_name,
                                patient_id: selectedPatientData.Patient_ID,
                                nurse_name: selectedPatientData.Nurse_name,
                                nurse_id: selectedPatientData.Nurse_ID,
                                owner_name: selectedPatient
