<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Search - Xforia</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/detailed-search.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/chatbot/latest/chatbot.css">
    <script src="https://cdn.dhtmlx.com/chatbot/latest/chatbot.js"></script>
</head>
<body>

    <header>
        <div class="logo-container">
            <img src="../images/logo.png" alt="Xforia COAST Logo" class="logo">
            <span class="tagline">Your tagline goes here.</span>
        </div>
        <div class="coast-flow-header">
            <div class="coast-step-container">
                <span class="coast-letter">C</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">O</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">A</span>
                <span class="coast-step-name"></span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter active">S</span>
                <span class="coast-step-name active">Search</span>
            </div>
            <div class="coast-step-container">
                <span class="coast-letter">T</span>
                <span class="coast-step-name"></span>
            </div>
        </div>
    </header>

    <main class="detailed-search-page">
        <section class="detailed-search-content">
            <h2 id="org-name-header" class="org-name-display"></h2>
            
            <div class="entity-selection-info">
                <p>Welcome <span id="selected-entity-display"></span>. Please make your selections to proceed.</p>
                <div id="entity-dropdowns" class="dropdown-container">
                    </div>
            </div>

            <div class="continue-options">
                <p>Choose your action:</p>
                <div class="option-buttons">
                    <button class="nav-option active" data-option="upload">Upload</button>
                    <button class="nav-option" data-option="chatbot">Chatbot</button>
                </div>
            </div>

            <div id="dynamic-content">
                </div>

            <div class="navigation-buttons">
                <button class="back-button" onclick="window.location.href='search.html'">Back</button>
                <button id="continue-to-report-btn" class="continue-button">Continue to Generate Report</button>
            </div>
        </section>
    </main>

    <script src="../js/scripts.js"></script>
    <script>
        const orgNameHeader = document.getElementById('org-name-header');
        const selectedEntityDisplay = document.getElementById('selected-entity-display');
        const entityDropdowns = document.getElementById('entity-dropdowns');
        const navOptions = document.querySelectorAll('.nav-option');
        const dynamicContent = document.getElementById('dynamic-content');
        const continueToReportBtn = document.getElementById('continue-to-report-btn');

        // Retrieve data from sessionStorage
        const orgName = sessionStorage.getItem('orgName');
        const selectedEntity = sessionStorage.getItem('selectedFinalEntity');
        const excelData = JSON.parse(sessionStorage.getItem('excelData')) || [];
        
        // Use the provided Excel data for a functional MVP
        const hardcodedExcelData = [
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '200', Nurse_name: 'Samuel Kim', Patient_name: 'Emily Johnson', Patient_ID: '300' },
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '200', Nurse_name: 'Samuel Kim', Patient_name: 'Liam Chen', Patient_ID: '301' },
            { Owner_ID: '101', Owner_name: 'Alexandra Singh', Nurse_ID: '201', Nurse_name: 'Olivia Garcia', Patient_name: 'Noah Smith', Patient_ID: '302' },
            { Owner_ID: '102', Owner_name: 'Raj Patel', Nurse_ID: '202', Nurse_name: 'Jasmine Lee', Patient_name: 'Sophia Rodriguez', Patient_ID: '303' },
            { Owner_ID: '102', Owner_name: 'Raj Patel', Nurse_ID: '202', Nurse_name: 'Jasmine Lee', Patient_name: 'Ethan White', Patient_ID: '304' },
        ];
        
        const workingData = excelData.length > 0 ? excelData : hardcodedExcelData;
        let selectedPatientId = null;

        if (orgName) orgNameHeader.textContent = orgName;
        if (selectedEntity) selectedEntityDisplay.textContent = selectedEntity;

        // Function to create a searchable dropdown
        function createSearchableDropdown(label, data, id, linkedId = null) {
            const container = document.createElement('div');
            container.classList.add('dropdown-group');

            const labelEl = document.createElement('label');
            labelEl.textContent = label;
            container.appendChild(labelEl);

            const inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.placeholder = `Search for ${label.toLowerCase()}`;
            inputEl.id = `${id}-input`;
            container.appendChild(inputEl);

            const resultsEl = document.createElement('ul');
            resultsEl.classList.add('autocomplete-results');
            container.appendChild(resultsEl);
            
            let currentData = data;

            inputEl.addEventListener('focus', () => {
                renderResults(currentData);
            });

            inputEl.addEventListener('input', () => {
                const query = inputEl.value.toLowerCase();
                const filteredData = currentData.filter(item => item.toLowerCase().includes(query));
                renderResults(filteredData);
            });

            const renderResults = (list) => {
                resultsEl.innerHTML = '';
                list.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = item;
                    li.addEventListener('click', () => {
                        inputEl.value = item;
                        resultsEl.innerHTML = '';
                        
                        if (id === 'patient-select') {
                            const selectedPatient = workingData.find(row => row.Patient_name === item);
                            if (selectedPatient) {
                                selectedPatientId = selectedPatient.Patient_ID;
                            }
                        }
                    });
                    resultsEl.appendChild(li);
                });
            };
            
            if (linkedId) {
                document.getElementById(`${linkedId}-input`).addEventListener('input', (e) => {
                    const selectedNurseName = e.target.value;
                    const filteredPatients = workingData
                        .filter(row => row.Nurse_name === selectedNurseName)
                        .map(row => row.Patient_name);
                    currentData = [...new Set(filteredPatients)];
                    inputEl.value = '';
                    selectedPatientId = null;
                });
            }
            
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    resultsEl.innerHTML = '';
                }
            });

            entityDropdowns.appendChild(container);
        }

        function renderDropdowns() {
            entityDropdowns.innerHTML = '';
            
            if (selectedEntity === 'patient' || selectedEntity === 'relative') {
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select');
            } else if (selectedEntity === 'nurse') {
                const nurseNames = [...new Set(workingData.map(row => row.Nurse_name))];
                createSearchableDropdown('Nurse Names', nurseNames, 'nurse-select');
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select', 'nurse-select');
            } else if (selectedEntity === 'owner') {
                const ownerNames = [...new Set(workingData.map(row => row.Owner_name))];
                createSearchableDropdown('Owner Names', ownerNames, 'owner-select');
                const nurseNames = [...new Set(workingData.map(row => row.Nurse_name))];
                createSearchableDropdown('Nurse Names', nurseNames, 'nurse-select');
                const patientNames = [...new Set(workingData.map(row => row.Patient_name))];
                createSearchableDropdown('Patient Names', patientNames, 'patient-select', 'nurse-select');
            }
        }
        
        renderDropdowns();

        navOptions.forEach(button => {
            button.addEventListener('click', (e) => {
                navOptions.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                const option = e.target.dataset.option;
                dynamicContent.innerHTML = '';

                if (option === 'upload') {
                    const patientName = document.getElementById('patient-select-input')?.value;
                    
                    if (!patientName) {
                        dynamicContent.innerHTML = `<div class="error-message">Please select a patient first.</div>`;
                        return;
                    }

                    dynamicContent.innerHTML = `
                        <div class="upload-section">
                            <h3>Upload More Documents for ${patientName}</h3>
                            <p>Upload a file for this patient. The patient ID and metadata will be added automatically.</p>
                            <form id="metadata-upload-form">
                                <div class="metadata-group">
                                    <label for="file-upload-2">Choose a file to upload:</label>
                                    <input type="file" id="file-upload-2">
                                </div>
                                <button type="submit">Upload Document</button>
                            </form>
                        </div>
                    `;
                    document.getElementById('metadata-upload-form').addEventListener('submit', (event) => {
                        event.preventDefault();
                        const file = document.getElementById('file-upload-2').files[0];
                        
                        const selectedPatientData = workingData.find(p => p.Patient_name === patientName);
                        if (!selectedPatientData) {
                            alert("An error occurred. Patient data not found.");
                            return;
                        }

                        const payload = {
                            file: file,
                            metadata: {
                                patient_name: selectedPatientData.Patient_name,
                                patient_id: selectedPatientData.Patient_ID,
                                nurse_name: selectedPatientData.Nurse_name,
                                nurse_id: selectedPatientData.Nurse_ID,
                                owner_name: selectedPatientData.Owner_name,
                                owner_id: selectedPatientData.Owner_ID,
                            }
                        };
                        console.log('Upload Payload:', payload);
                        alert('Upload Successful!');
                    });
                } else if (option === 'chatbot') {
                    dynamicContent.innerHTML = `
                        <div class="chatbot-container">
                            <div id="chatbot-widget"></div>
                        </div>
                    `;
                    const chatbot = new dhx.Chatbot("chatbot-widget");
                    
                    chatbot.ask = async (text) => {
                        const patientName = document.getElementById('patient-select-input')?.value;
                        const selectedPatientData = workingData.find(p => p.Patient_name === patientName);
                        
                        const payload = {
                            conversation_id: "your-session-id", 
                            query: text,
                            user_type: selectedEntity,
                            patient_name: patientName || null,
                            patient_id: selectedPatientData ? selectedPatientData.Patient_ID : null
                        };
                        console.log("Chatbot Payload:", payload);
                        try {
                            const response = await fetch('https://your-backend-api.com/query', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload)
                            });
                            const result = await response.json();
                            return result.answer;
                        } catch (error) {
                            console.error("Chatbot API Error:", error);
                            return "Sorry, I'm having trouble connecting right now.";
                        }
                    };
                }
            });
        });
        
        document.querySelector('.nav-option[data-option="upload"]').click();

        continueToReportBtn.addEventListener('click', () => {
            window.location.href = 'track.html';
        });
    </script>
</body>
</html>
